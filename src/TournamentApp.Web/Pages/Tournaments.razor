@page "/tournaments"
@using MudBlazor
@using TournamentApp.Application.DTOs
@inject HttpClient Http
@inject ISnackbar Snackbar

<PageTitle>Tournaments</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Tournaments</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="ShowCreateDialog">
    Create Tournament
</MudButton>

@if (_errorMessage != null)
{
    <MudAlert Severity="Severity.Error" Class="mt-4">
        <MudText Typo="Typo.h6">Error Loading Tournaments</MudText>
        <MudText>@_errorMessage</MudText>
    </MudAlert>
}
else if (_tournaments == null)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-3" />
}
else if (_tournaments.Count == 0)
{
    <MudText Class="mt-4">No tournaments found. Create one to get started!</MudText>
}
else
{
    <MudTable Items="@_tournaments" Hover="true" Striped="true" Dense="true" Class="mt-4">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Created</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">@context.Status</MudChip>
            </MudTd>
            <MudTd DataLabel="Created">@context.CreatedAt.ToString("g")</MudTd>
            <MudTd DataLabel="Actions">
                <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                    <MudButton StartIcon="@Icons.Material.Filled.Visibility" OnClick="@(() => ViewBracket(context.Id))">View</MudButton>
                    <MudButton StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="@(() => GenerateBracket(context.Id))">Generate Bracket</MudButton>
                </MudButtonGroup>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private List<TournamentDto>? _tournaments;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadTournaments();
    }

    private async Task LoadTournaments()
    {
        _errorMessage = null;
        try
        {
            var response = await Http.GetAsync("api/tournaments");
            
            if (response.IsSuccessStatusCode)
            {
                _tournaments = await response.Content.ReadFromJsonAsync<List<TournamentDto>>();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                var errorMsg = $"HTTP {response.StatusCode}: {errorContent}";
                _errorMessage = errorMsg;
                Snackbar.Add($"Error loading tournaments: {errorMsg}", Severity.Error);
            }
        }
        catch (HttpRequestException ex)
        {
            var errorMsg = $"Network error: {ex.Message}";
            _errorMessage = errorMsg;
            Snackbar.Add(errorMsg, Severity.Error);
        }
        catch (Exception ex)
        {
            var errorMsg = $"Error: {ex.Message}";
            _errorMessage = errorMsg;
            Snackbar.Add($"Error loading tournaments: {errorMsg}", Severity.Error);
        }
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Draft" => Color.Default,
            "InProgress" => Color.Info,
            "Completed" => Color.Success,
            _ => Color.Default
        };
    }

    private void ShowCreateDialog()
    {
        // TODO: Implement create tournament dialog
        Snackbar.Add("Create tournament dialog - to be implemented", Severity.Info);
    }

    private void ViewBracket(Guid tournamentId)
    {
        // TODO: Navigate to bracket view
        Snackbar.Add($"View bracket for tournament {tournamentId} - to be implemented", Severity.Info);
    }

    private async Task GenerateBracket(Guid tournamentId)
    {
        try
        {
            var response = await Http.PostAsync($"api/tournaments/{tournamentId}/bracket/generate", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Bracket generated successfully!", Severity.Success);
                await LoadTournaments();
            }
            else
            {
                Snackbar.Add("Error generating bracket", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}

