name: Deploy Web

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Publish Blazor WASM
      run: dotnet publish src/TournamentApp.Web/TournamentApp.Web.csproj -c Release -o publish

    - name: Determine deploy directory
      id: prepare
      run: |
        if [ -d "publish/wwwroot/tournament-app" ]; then
          DEPLOY_DIR="publish/wwwroot/tournament-app"
        elif [ -d "publish/wwwroot" ]; then
          DEPLOY_DIR="publish/wwwroot"
        else
          echo "Deploy directory not found"
          exit 1
        fi

        echo "deploy_dir=$DEPLOY_DIR" >> $GITHUB_OUTPUT

        sed -i "s|%BASE_HREF%|/tournament-app/|g" "$DEPLOY_DIR/index.html"

        cp "$DEPLOY_DIR/index.html" "$DEPLOY_DIR/404.html"

        touch "$DEPLOY_DIR/.nojekyll"

    - name: Apply DEV configuration
      if: ${{ github.event.inputs.environment == 'dev' }}
      run: |
        DEPLOY_DIR="${{ steps.prepare.outputs.deploy_dir }}"
        sed -i "s|%API_BASE_URL%|https://tournament-app-dev.fly.dev|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%COGNITO_CLIENT_ID%|${{ vars.COGNITO_CLIENT_ID }}|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%COGNITO_AUTHORITY%|${{ vars.COGNITO_AUTHORITY }}|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%COGNITO_REDIRECT_URI%|${{ vars.COGNITO_REDIRECT_URI }}|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%COGNITO_DOMAIN%|${{ vars.COGNITO_DOMAIN }}|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%BASE_PATH%|/tournament-app|g" "$DEPLOY_DIR/appsettings.json"

    - name: Apply PROD configuration
      if: ${{ github.event.inputs.environment == 'prod' }}
      run: |
        DEPLOY_DIR="${{ steps.prepare.outputs.deploy_dir }}"
        sed -i "s|%API_BASE_URL%|https://tournament-app.fly.dev|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%COGNITO_CLIENT_ID%|${{ vars.COGNITO_CLIENT_ID }}|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%COGNITO_AUTHORITY%|${{ vars.COGNITO_AUTHORITY }}|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%COGNITO_REDIRECT_URI%|${{ vars.COGNITO_REDIRECT_URI }}|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%COGNITO_DOMAIN%|${{ vars.COGNITO_DOMAIN }}|g" "$DEPLOY_DIR/appsettings.json"
        sed -i "s|%BASE_PATH%|/tournament-app|g" "$DEPLOY_DIR/appsettings.json"

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./${{ steps.prepare.outputs.deploy_dir }}
