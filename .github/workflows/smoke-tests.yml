name: Smoke Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - dev
          - prod
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_run:
    workflows: ["Deploy API", "Deploy Web"]
    types:
      - completed

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test static site
      run: |
        WEB_URL="${{ vars.WEB_APP_URL }}"
        if [ -z "$WEB_URL" ]; then
          echo "Error: WEB_APP_URL environment variable is not set. Please set it in GitHub repository/environment variables."
          exit 1
        fi
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEB_URL")
        if [ "$STATUS" -ne 200 ]; then
          echo "Static site returned status $STATUS for URL: $WEB_URL"
          exit 1
        fi
        echo "Static site is accessible at: $WEB_URL"

    - name: Test API health endpoint
      run: |
        FLY_APP_URL="${{ vars.FLY_APP_URL }}"
        if [ -z "$FLY_APP_URL" ]; then
          echo "Error: FLY_APP_URL environment variable is not set"
          exit 1
        fi
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FLY_APP_URL/health")
        if [ "$STATUS" -ne 200 ]; then
          echo "API health endpoint returned status $STATUS"
          exit 1
        fi
        echo "API health endpoint is accessible"

    - name: Test API database check
      run: |
        FLY_APP_URL="${{ vars.FLY_APP_URL }}"
        if [ -z "$FLY_APP_URL" ]; then
          echo "Error: FLY_APP_URL environment variable is not set"
          exit 1
        fi
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FLY_APP_URL/dbcheck")
        if [ "$STATUS" -ne 200 ]; then
          echo "API database check returned status $STATUS"
          exit 1
        fi
        echo "API database check passed"

    - name: Validate Cognito OpenID configuration
      run: |
        COGNITO_DOMAIN="${{ vars.COGNITO_DOMAIN }}"
        if [ -z "$COGNITO_DOMAIN" ]; then
          echo "Error: COGNITO_DOMAIN environment variable is not set"
          exit 1
        fi
        OPENID_CONFIG=$(curl -s "https://${COGNITO_DOMAIN}/.well-known/openid-configuration")
        if [ -z "$OPENID_CONFIG" ] || echo "$OPENID_CONFIG" | grep -q "error"; then
          echo "Cognito OpenID configuration is not accessible"
          exit 1
        fi
        echo "Cognito OpenID configuration is valid"
