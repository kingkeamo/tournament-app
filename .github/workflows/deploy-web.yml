name: Deploy Web

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
  push:
    branches:
      - main
    paths:
      - 'src/TournamentApp.Web/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'dev') }}
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Set ASP.NET environment
      run: echo "ASPNETCORE_ENVIRONMENT=Production" >> $GITHUB_ENV

    - name: Build and publish
      run: dotnet publish src/TournamentApp.Web/TournamentApp.Web.csproj -c Release -o publish

    - name: Prepare for GitHub Pages
      id: prepare
      run: |
        # Determine deploy directory (StaticWebAssetBasePath puts files in tournament-app subdirectory)
        if [ -d "publish/wwwroot/tournament-app" ]; then
          DEPLOY_DIR="publish/wwwroot/tournament-app"
        elif [ -d "publish/wwwroot" ]; then
          DEPLOY_DIR="publish/wwwroot"
        elif [ -f "publish/index.html" ]; then
          DEPLOY_DIR="publish"
        else
          echo "Error: index.html not found in expected location"
          exit 1
        fi

        echo "Using deploy directory: ${DEPLOY_DIR}"
        echo "deploy_dir=${DEPLOY_DIR}" >> $GITHUB_OUTPUT

        # Set base href for GitHub Pages (replace placeholder)
        sed -i 's|%BASE_HREF%|/tournament-app/|g' "${DEPLOY_DIR}/index.html"
        
        echo "---- Base href check ----"
        grep -i "base href" "${DEPLOY_DIR}/index.html" || echo "WARNING: base href not found"

        # Replace placeholders in appsettings.json will be done in separate steps below

        # SPA routing fix
        cp "${DEPLOY_DIR}/index.html" "${DEPLOY_DIR}/404.html"
        
        # Also update base href in 404.html
        sed -i 's|%BASE_HREF%|/tournament-app/|g' "${DEPLOY_DIR}/404.html"

        # Avoid jekyll ignoring folders starting with _
        touch "${DEPLOY_DIR}/.nojekyll"

    - name: Set API base URL (dev)
      if: github.event.inputs.environment == 'dev' || (github.event.inputs.environment == '' && github.ref != 'refs/heads/main')
      run: |
        DEPLOY_DIR="${{ steps.prepare.outputs.deploy_dir }}"
        if [ -f "${DEPLOY_DIR}/appsettings.json" ]; then
          sed -i "s|%API_BASE_URL%|https://tournament-app-dev.fly.dev|g" "${DEPLOY_DIR}/appsettings.json"
        fi

    - name: Set API base URL (prod)
      if: github.event.inputs.environment == 'prod' || (github.event.inputs.environment == '' && github.ref == 'refs/heads/main')
      run: |
        DEPLOY_DIR="${{ steps.prepare.outputs.deploy_dir }}"
        if [ -f "${DEPLOY_DIR}/appsettings.json" ]; then
          sed -i "s|%API_BASE_URL%|https://tournament-app.fly.dev|g" "${DEPLOY_DIR}/appsettings.json"
        fi

    - name: Replace Cognito placeholders
      run: |
        DEPLOY_DIR="${{ steps.prepare.outputs.deploy_dir }}"
        if [ -f "${DEPLOY_DIR}/appsettings.json" ]; then
          sed -i "s|%COGNITO_CLIENT_ID%|${{ vars.COGNITO_CLIENT_ID }}|g" "${DEPLOY_DIR}/appsettings.json"
          sed -i "s|%COGNITO_AUTHORITY%|${{ vars.COGNITO_AUTHORITY }}|g" "${DEPLOY_DIR}/appsettings.json"
          sed -i "s|%COGNITO_REDIRECT_URI%|${{ vars.COGNITO_REDIRECT_URI }}|g" "${DEPLOY_DIR}/appsettings.json"
          sed -i "s|%COGNITO_DOMAIN%|${{ vars.COGNITO_DOMAIN }}|g" "${DEPLOY_DIR}/appsettings.json"
        fi

    - name: Replace GitHub Pages base path
      run: |
        DEPLOY_DIR="${{ steps.prepare.outputs.deploy_dir }}"
        if [ -f "${DEPLOY_DIR}/appsettings.json" ]; then
          sed -i "s|%BASE_PATH%|/tournament-app|g" "${DEPLOY_DIR}/appsettings.json"
        fi

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./${{ steps.prepare.outputs.deploy_dir }}
